        <!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <title>Embedding Audio With Audacity &middot; Web Portfolio of John Westhoff</title>
  <link rel="stylesheet" href="https://www.johnbot.me/css/style.css" />
  <link rel="stylesheet" href="https://www.johnbot.me/css/font-awesome.min.css" />
  <link rel="icon" href="/favicon.png" type="image/png" />
  <link href='https://fonts.googleapis.com/css?family=Lato:100,300,400,600' rel='stylesheet' type='text/css'>
</head>
<body>

<header class="header" style="background-color: #009DDC;
    background-image: url(https://www.johnbot.me/img/texture.png),linear-gradient(to bottom, #009DDC, #006ccb);background-repeat: repeat, no-repeat;background-position: left top, left top;background-size: 100px 100px, 100% 100%;" role="banner">

      <section id="branding">
        <div id="site-title"><a href="https://www.johnbot.me">Web Portfolio of John Westhoff</a></div>
        <nav id="mainmenu">
          <ul>
            <li><a href="https://www.johnbot.me">Posts</a></li>
            <li><a href="http://github.com/johnathonnow" target="_blank">Github</a></li>
            
            <li><a href="https://www.linkedin.com/in/johnjwesthoff" target="_blank">LinkedIn</a></li>
          </ul>
        </nav>
        <input type="checkbox" id="op"></input>
        <div class="lower">
          <label for="op">Menu</label>
        </div>
        <div class="overlay overlay-hugeinc">
          <label for="op"></label>
          <nav id="menu" role="navigation">
            <ul>
            <li><a href="https://www.johnbot.me">Posts</a></li>
            <li><a href="http://github.com/johnathonnow" target="_blank">Github</a></li>
            
            <li><a href="https://www.linkedin.com/in/johnjwesthoff" target="_blank">LinkedIn</a></li>
          </ul>
          </nav>
        </div>
        <div class="clearfix"></div>
      </section>
      <div class="post-heading">
        <h1>
        Embedding Audio With Audacity
          <div class="share-icons-header">
            <a href="http://www.twitter.com/share?url=https%3a%2f%2fwww.johnbot.me%2fpost%2ffirstaudacityplugin%2f" target="_blank">
            <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 612 612" style="enable-background:new 0 0 612 612;" xml:space="preserve">
            <g>
              <g>
                <path d="M437.219,245.162c0-3.088-0.056-6.148-0.195-9.18c13.214-9.848,24.675-22.171,33.744-36.275
                  c-12.129,5.453-25.148,9.097-38.835,10.626c13.965-8.596,24.675-22.338,29.738-38.834c-13.075,7.928-27.54,13.603-42.924,16.552
                  c-12.323-14.021-29.904-22.95-49.35-23.284c-37.332-0.612-67.598,30.934-67.598,70.463c0,5.619,0.584,11.072,1.752,16.329
                  c-56.22-3.616-106.042-32.881-139.369-77c-5.814,10.571-9.152,22.922-9.152,36.164c0,25.037,11.934,47.291,30.071,60.421
                  c-11.099-0.5-21.503-3.866-30.627-9.375c0,0.306,0,0.612,0,0.918c0,34.996,23.312,64.316,54.245,71.159
                  c-5.675,1.613-11.656,2.448-17.804,2.421c-4.367-0.028-8.596-0.501-12.713-1.392c8.596,28.681,33.577,49.628,63.147,50.323
                  c-23.145,19.194-52.298,30.655-83.955,30.572c-5.453,0-10.849-0.361-16.135-1.029c29.933,20.53,65.456,32.491,103.65,32.491
                  C369.23,447.261,437.219,339.048,437.219,245.162z"/>
                <path d="M612,306C612,137.004,474.995,0,306,0C137.004,0,0,137.004,0,306c0,168.995,137.004,306,306,306
                  C474.995,612,612,474.995,612,306z M27.818,306C27.818,152.36,152.36,27.818,306,27.818S584.182,152.36,584.182,306
                  S459.64,584.182,306,584.182S27.818,459.64,27.818,306z"/>
              </g>
            </svg></a>
            <a href="http://plus.google.com/share?url=https%3a%2f%2fwww.johnbot.me%2fpost%2ffirstaudacityplugin%2f" target="_blank">
            <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 612 612" style="enable-background:new 0 0 612 612;" xml:space="preserve">
              <g>
                <g>
                  <path d="M349.146,402.251c0-30.016-17.387-44.815-36.525-60.922l-15.662-12.185c-4.785-3.895-11.294-9.124-11.294-18.693
                    c0-9.57,6.537-15.662,12.184-21.309c18.249-14.354,36.526-29.571,36.526-61.756c0-33.076-20.892-50.462-30.878-58.724l0,0h26.956
                    L358.271,153h-89.603c-23.479,0-53.049,3.478-77.863,23.924c-18.693,16.079-27.818,38.278-27.818,58.279
                    c0,33.911,26.093,68.294,72.188,68.294c4.368,0,9.125-0.445,13.937-0.863c-2.17,5.23-4.34,9.569-4.34,16.97
                    c0,13.464,6.955,21.753,13.047,29.57c-19.556,1.308-56.109,3.478-83.065,20.001c-25.676,15.217-33.493,37.416-33.493,53.077
                    c0,32.186,30.461,62.201,93.525,62.201C309.561,484.454,349.146,443.116,349.146,402.251z M255.621,291.34
                    c-37.415,0-54.384-48.292-54.384-77.418c0-11.322,2.17-23.034,9.569-32.186c6.955-8.707,19.139-14.382,30.461-14.382
                    c36.108,0,54.802,48.738,54.802,80.033c0,7.845-0.862,21.754-10.877,31.768C278.237,286.11,266.498,291.312,255.621,291.34z
                     M256.066,466.177c-46.54,0-76.556-22.171-76.556-53.049s27.846-41.311,37.416-44.787c18.276-6.093,41.755-6.982,45.677-6.982
                    c4.34,0,6.51,0,9.987,0.445c33.076,23.479,47.402,35.218,47.402,57.416C319.992,446.176,297.821,466.177,256.066,466.177z"/>
                  <polygon points="353.068,317.768 400.164,317.768 400.164,364.836 423.699,364.836 423.699,317.768 470.768,317.768 
                    470.768,294.233 423.699,294.233 423.699,247.165 400.164,247.165 400.164,294.233 353.068,294.233     "/>
                  <path d="M612,306C612,137.004,474.995,0,306,0C137.004,0,0,137.004,0,306c0,168.995,137.004,306,306,306
                    C474.995,612,612,474.995,612,306z M27.818,306C27.818,152.36,152.36,27.818,306,27.818S584.182,152.36,584.182,306
                    S459.64,584.182,306,584.182S27.818,459.64,27.818,306z"/>
                </g>
            </svg></a>
            <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.johnbot.me%2fpost%2ffirstaudacityplugin%2f" target="_blank">
            <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
               viewBox="0 0 612 612" style="enable-background:new 0 0 612 612;" xml:space="preserve">
            <g>
              <g>
                <path d="M612,306C612,137.004,474.995,0,306,0C137.004,0,0,137.004,0,306c0,168.995,137.004,306,306,306
                  C474.995,612,612,474.995,612,306z M27.818,306C27.818,152.36,152.36,27.818,306,27.818S584.182,152.36,584.182,306
                  S459.64,584.182,306,584.182S27.818,459.64,27.818,306z"/>
                <path d="M317.739,482.617V306h58.279l9.208-58.529h-67.487v-29.348c0-15.272,5.007-29.849,26.928-29.849h43.813v-58.418h-62.201
                  c-52.298,0-66.569,34.438-66.569,82.175v35.413h-35.885V306h35.885v176.617H317.739L317.739,482.617z"/>
              </g>
            </svg>
            </a>
          </div>
          
        </h1>
      </div>

    </header>

    <div id="container">

    
    <section id="content" role="main">
    <section class="entry-meta">
      <span class="post-date">Jul 10, 2016</span>
    </section></header>
    <section class="entry-content">
    <article>
    

<p>A friend came to me with a request to create an <a href="http://www.audacityteam.org/">Audacity</a> plugin that,
given two stereo audio tracks, takes the second audio track and ensures that it stays
X decibels below the first audio track.</p>

<p>The project did not take long after establishing just what it means for a track to be quieter
than another, despite me having never written anything in a LISP dialect
(Audacity uses Nyquist/XLISP) and some of the oddities of Audacity that I will describe below.</p>

<h2 id="quieter-audio:83c068686d9ce68651d7f4789470e27a">Quieter Audio</h2>

<p>Digital audio is more or less stored as a collection of samples of a sound wave, with many
discrete points used to approximate a continuous waveform. The friend who asked me to do the
project told me that what I should do is set every sample in the second track to the
corresponding sample in the first track minus X. This is not at all what was actually wanted,
however, as that would merely produce the first track but X decibels quieter - it would not
matter what the second track was, it would be entirely overwritten.</p>

<p><img src="starting_waveform.png" alt="png" /><br />
My set of starting waveforms (in order of Track 1 Left, Track 1 Right, Track 2 Left, Track
2 Right). Track 1 was generated as a 440 Hz sine wave with some fading to shape it, while
Track 2 was generated as a 4400 Hz uniform sine wave.</p>

<p>Instead what I aimed to do was approximate the &ldquo;loudness&rdquo; over time by taking the absolute
value of the waveform (so it is always positive), multiplying the waveform by the sqrt(2)
(to keep it closer to the peaks of the waveform), and passing it through a <a href="https://en.wikipedia.org/wiki/Low-pass_filter">low-pass filter</a> (to essentially make it a rolling average).</p>

<p><img src="rms_lowpassed_waveform.png" alt="png" /><br />
The result of my loudness function. Note that it approximates the &ldquo;shape&rdquo; and &ldquo;size&rdquo; of
the prior waveforms.</p>

<h2 id="audacity-oddities:83c068686d9ce68651d7f4789470e27a">Audacity Oddities</h2>

<p>Audacity plugins are extremely powerful, but there are a few things that can bite you,
especially since Audacity does not natively support running a plugin on multiple tracks.
When you run a plugin on multiple tracks, in runs the plugin sequentially on each track,
one at a time.
For my use, editing a track based on another, this was a problem.
There are two variables that can help solve this, however:
1. The <em>TRACK</em> environmental variable, which has an INDEX property. This property tells which
track the plugin is currently running on. <em>TRACK</em> also contains the data for the current sound.<br />
2. The <em>SCRATCH</em> environmental variable, which is the only usable persistent variable for passing
data between tracks.</p>

<p>My first instinct was to use the <em>TRACK</em> INDEX property to get the loudness waveform from
the first track and store it in the <em>SCRATCH</em> variable. It turns out, however, that Audacity
sounds are just references, and they are cleared after each run of the plugin!<br />
My next thought was to save the waveform as an array of samples, but that would be several
hundred megabytes worth of memory, which isn&rsquo;t really acceptable.<br />
My solution to this, then, was to loop over the loudness waveform and fill a list with the changes
in loudness as well as the time the change occured. In the second track, I would then recreate
the loudness waveform from that list. It turns out, Audacity already has a function for doing so -
the <code>pwl-list</code> function. This saved me from having to write my own.</p>

<h2 id="modifying-the-second-track:83c068686d9ce68651d7f4789470e27a">Modifying the Second Track</h2>

<p>After recreating the loudness of the first track, I find the loudness of the second. By subtracting
the two (expressed in decibel form rather than linear) with an offset of X db added to the second track,
converting the result back to a linear scale and multiply it by the second track, I am able to ensure
that the loudness of the second track mirros the loudness of the first, offset by X db. This works because the decibel unit is logarithmic, and one property
of logarithms is log(x) + log(y) = log(x*y). So, to change an amplitude X by Y
units, we subtract the two and multiply X by the result expressed back in linear
form.</p>

<p><img src="end_waveform.png" alt="png" /><br />
The final set of waveforms. Notice that the second set of waveforms has a similar shape to the first set,
while still keeping its musical properties (in this case, pitch). Perhaps a real song sample would show
the results better - perhaps I will update the article with some public domain songs.</p>

<p>What I&rsquo;ve done is not even close to being perfect, but it doesn&rsquo;t really need to be. I feel it was
a good introduction to a LISP dialect, and my friend was happy with the results.</p>

<p>The full code is available in this gist:<br />
<script src="https://gist.github.com/JohnathonNow/daaa8749a40215b29c51fc6845af0743.js"></script>
<a href="https://gist.github.com/JohnathonNow/daaa8749a40215b29c51fc6845af0743">Direct link</a></p>

    </section>
    <div class="entry-links"></div>
    </article>
    <div class="share-icons-body">
      <a href="http://www.twitter.com/share?url=https%3a%2f%2fwww.johnbot.me%2fpost%2ffirstaudacityplugin%2f" target="_blank">
      <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 612 612" style="enable-background:new 0 0 612 612;" xml:space="preserve">
      <g>
        <g>
          <path d="M437.219,245.162c0-3.088-0.056-6.148-0.195-9.18c13.214-9.848,24.675-22.171,33.744-36.275
            c-12.129,5.453-25.148,9.097-38.835,10.626c13.965-8.596,24.675-22.338,29.738-38.834c-13.075,7.928-27.54,13.603-42.924,16.552
            c-12.323-14.021-29.904-22.95-49.35-23.284c-37.332-0.612-67.598,30.934-67.598,70.463c0,5.619,0.584,11.072,1.752,16.329
            c-56.22-3.616-106.042-32.881-139.369-77c-5.814,10.571-9.152,22.922-9.152,36.164c0,25.037,11.934,47.291,30.071,60.421
            c-11.099-0.5-21.503-3.866-30.627-9.375c0,0.306,0,0.612,0,0.918c0,34.996,23.312,64.316,54.245,71.159
            c-5.675,1.613-11.656,2.448-17.804,2.421c-4.367-0.028-8.596-0.501-12.713-1.392c8.596,28.681,33.577,49.628,63.147,50.323
            c-23.145,19.194-52.298,30.655-83.955,30.572c-5.453,0-10.849-0.361-16.135-1.029c29.933,20.53,65.456,32.491,103.65,32.491
            C369.23,447.261,437.219,339.048,437.219,245.162z"/>
          <path d="M612,306C612,137.004,474.995,0,306,0C137.004,0,0,137.004,0,306c0,168.995,137.004,306,306,306
            C474.995,612,612,474.995,612,306z M27.818,306C27.818,152.36,152.36,27.818,306,27.818S584.182,152.36,584.182,306
            S459.64,584.182,306,584.182S27.818,459.64,27.818,306z"/>
        </g>
      </svg></a>
      <a href="http://plus.google.com/share?url=https%3a%2f%2fwww.johnbot.me%2fpost%2ffirstaudacityplugin%2f" target="_blank">
      <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 612 612" style="enable-background:new 0 0 612 612;" xml:space="preserve">
        <g>
          <g>
            <path d="M349.146,402.251c0-30.016-17.387-44.815-36.525-60.922l-15.662-12.185c-4.785-3.895-11.294-9.124-11.294-18.693
              c0-9.57,6.537-15.662,12.184-21.309c18.249-14.354,36.526-29.571,36.526-61.756c0-33.076-20.892-50.462-30.878-58.724l0,0h26.956
              L358.271,153h-89.603c-23.479,0-53.049,3.478-77.863,23.924c-18.693,16.079-27.818,38.278-27.818,58.279
              c0,33.911,26.093,68.294,72.188,68.294c4.368,0,9.125-0.445,13.937-0.863c-2.17,5.23-4.34,9.569-4.34,16.97
              c0,13.464,6.955,21.753,13.047,29.57c-19.556,1.308-56.109,3.478-83.065,20.001c-25.676,15.217-33.493,37.416-33.493,53.077
              c0,32.186,30.461,62.201,93.525,62.201C309.561,484.454,349.146,443.116,349.146,402.251z M255.621,291.34
              c-37.415,0-54.384-48.292-54.384-77.418c0-11.322,2.17-23.034,9.569-32.186c6.955-8.707,19.139-14.382,30.461-14.382
              c36.108,0,54.802,48.738,54.802,80.033c0,7.845-0.862,21.754-10.877,31.768C278.237,286.11,266.498,291.312,255.621,291.34z
               M256.066,466.177c-46.54,0-76.556-22.171-76.556-53.049s27.846-41.311,37.416-44.787c18.276-6.093,41.755-6.982,45.677-6.982
              c4.34,0,6.51,0,9.987,0.445c33.076,23.479,47.402,35.218,47.402,57.416C319.992,446.176,297.821,466.177,256.066,466.177z"/>
            <polygon points="353.068,317.768 400.164,317.768 400.164,364.836 423.699,364.836 423.699,317.768 470.768,317.768 
              470.768,294.233 423.699,294.233 423.699,247.165 400.164,247.165 400.164,294.233 353.068,294.233     "/>
            <path d="M612,306C612,137.004,474.995,0,306,0C137.004,0,0,137.004,0,306c0,168.995,137.004,306,306,306
              C474.995,612,612,474.995,612,306z M27.818,306C27.818,152.36,152.36,27.818,306,27.818S584.182,152.36,584.182,306
              S459.64,584.182,306,584.182S27.818,459.64,27.818,306z"/>
          </g>
      </svg></a>
      <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.johnbot.me%2fpost%2ffirstaudacityplugin%2f" target="_blank">
      <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
         viewBox="0 0 612 612" style="enable-background:new 0 0 612 612;" xml:space="preserve">
      <g>
        <g>
          <path d="M612,306C612,137.004,474.995,0,306,0C137.004,0,0,137.004,0,306c0,168.995,137.004,306,306,306
            C474.995,612,612,474.995,612,306z M27.818,306C27.818,152.36,152.36,27.818,306,27.818S584.182,152.36,584.182,306
            S459.64,584.182,306,584.182S27.818,459.64,27.818,306z"/>
          <path d="M317.739,482.617V306h58.279l9.208-58.529h-67.487v-29.348c0-15.272,5.007-29.849,26.928-29.849h43.813v-58.418h-62.201
            c-52.298,0-66.569,34.438-66.569,82.175v35.413h-35.885V306h35.885v176.617H317.739L317.739,482.617z"/>
        </g>
      </svg>
      </a>
    </div>
    <div class="clearfix"></div>
<div>
    Tags: 
    
        <a href="/tags/projects">Projects</a> 
    
        <a href="/tags/audacity">Audacity</a> 
    
        <a href="/tags/audio">Audio</a> 
    
        <a href="/tags/medic">Medic</a> 
    
</div>
<figure class="author-bio">
<img class="bio-image" src="../../img/avatar.jpg" />
<figcaption class="bio-text">I am currently a sophomore Computer Science student at the University of Notre Dame. I am interested in Robotics, and I help coach a local South Bend team. I am a member of the Notre Dame Linux Users Group. I enjoy working on side projects, some of which I intend to post here.</figcaption>
</figure>
<hr>

</section>
<div class="clear"></div>
</div>
<footer id="footer" style="color: #7A7B7C; background-color: #3A3B3C;background-image: url(https://www.johnbot.me/img/texture.png),linear-gradient(to bottom, #3A3B3C, #1d1e1e); background-repeat: repeat, no-repeat; background-position: left top, left top; background-size: 100px 100px, 100% 100%;">
  <div id="footer-container">
  
  
  
  <div class="clearfix"></div>
  </div>
  <div id="copyright"></div>
</footer>
<script src="https://www.johnbot.me/js/highlight.pack.js"></script>
  <script>
    hljs.initHighlightingOnLoad();
  </script>
  
</div>
</body>
    <link rel="shortcut icon" href="https://www.johnbot.me/img/favicon.ico" />
    <link rel="apple-touch-icon" href="https://www.johnbot.me/img/apple-touch-icon.jpg" />
</html>
